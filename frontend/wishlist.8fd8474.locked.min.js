var demo_session="OG Wish List",state={session:null,user:null,socketConnected:!1,isLockedDown:!0};function main(){var e=cookieHandler.getSession(),t=cookieHandler.getUser();isBlankString(e)||isBlankString(t)?homepage.init():wishlistApp.init()}function isBlankString(e){return""==e||"null"==e}function sleep(e){return new Promise(t=>setTimeout(t,e))}var homepage=function(){var e=function(){$("#logged-out").hide()},t=function(){n(),$("#logged-out").show(),s()},n=function(){var e=document.getElementById("css-link"),t=document.createElement("link");t.id="css-link",t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href","logged-out.css"),document.getElementsByTagName("head").item(0).replaceChild(t,e)},s=function(){document.getElementById("sign-in-link").addEventListener("click",function(t){t.preventDefault(),function(){state.session=document.getElementsByTagName("input")[0].value,state.user=document.getElementsByTagName("input")[1].value;var t=state.session!=demo_session?document.getElementsByTagName("input")[2].value:"";restApp.signIn(t)?(cookieHandler.setSession(state.session),cookieHandler.setUser(state.user),e(),wishlistApp.init()):(state.session=null,state.user=null,alert("The session, username, or password you entered are incorrect. Please try again."))}()})};return{init:function(){cookieHandler.clearCookies(),wishlistApp.close(),t()},close:e}}(),wishlistApp=function(){var e=[],t=[],n=function(){websocketApp.close(),$("#logged-out").hide(),state.session=null,state.user=null,e=null,t=null},s=function(){var e=document.getElementById("css-link"),t=document.createElement("link");t.id="css-link",t.setAttribute("rel","stylesheet"),t.setAttribute("type","text/css"),t.setAttribute("href","logged-in.css"),document.getElementsByTagName("head").item(0).replaceChild(t,e)},r=async function(){document.getElementById("banner-text").appendChild(document.createTextNode(state.session)),e=await restApp.getItems(),refreshOwners();clearLists(!0),populateLists(!0),state.isLockedDown&&setSaveLock(),setupWishlistListeners(!0)};return clearLists=function(e){if(e){var t=document.getElementById("save-div"),n=document.getElementById("lists"),s=document.createElement("div");s.id="other-lists",n.innerHTML="",n.appendChild(s),n.appendChild(t)}else document.getElementById("other-lists").innerHTML=""},refreshOwners=function(){t=[];for(var n=0;n<e.length;n++)t.includes(e[n].owner)||t.push(e[n].owner)},populateLists=function(n){for(var s=0;s<t.length;s++)if(n&&t[s]==state.user){var i=document.getElementById("lists"),r=createList(state.user);i.insertBefore(r,i.firstChild)}else if(t[s]!=state.user){var a=document.getElementById("other-lists"),o=createList(t[s]);a.appendChild(o)}for(s=0;s<e.length;s++)if(n||e[s].owner!=state.user){var l=document.getElementById("list_"+e[s].owner),c=createItem(e[s],1==l.childElementCount);l.appendChild(c)}if(n&&!state.isLockedDown){r=document.getElementById("list_"+state.user);var d=createAddItem();r.appendChild(d)}},createList=function(e){var t=document.createElement("table");t.id="list_"+e,t.className="table table-bordered",state.user!=e?t.setAttribute("style","width: 22%;vertical-align: top;margin: 0;padding: 0;display: inline;"):t.setAttribute("style","width: 17%;vertical-align: top;margin: 0;padding: 0;float: left;");var n=document.createElement("th");n.appendChild(document.createTextNode(e));var s=document.createElement("tr");return s.appendChild(n),t.appendChild(s),t},createItem=function(e,t){var n=document.createElement("td");n.className="wl-td",n.style.backgroundColor=t?"#69a0f3":"snow";var s=document.createElement("div");s.className="wl-price-box",s.innerText=e.price,state.user!=e.owner||state.isLockedDown||s.setAttribute("contenteditable",""),n.appendChild(s);var i=document.createElement("div");if(n.appendChild(i),state.user==e.owner?(state.isLockedDown||i.setAttribute("contenteditable",""),i.className="wl-item-content-user"):""!=e.claimer&&e.claimer!=state.user?i.className="wl-item-content-claimed":i.className="wl-item-content",i.appendChild(document.createTextNode(e.name)),""==e.claimer&&state.user!=e.owner||e.claimer==state.user){var r=document.createElement("input");r.className="wl-checkbox",r.setAttribute("type","checkbox"),e.claimer==state.user&&r.setAttribute("checked",""),n.appendChild(r)}var a=document.createElement("div");a.setAttribute("style","display: none;"),a.textContent=e.descr,n.appendChild(a);var o=document.createElement("tr");return o.appendChild(n),o},createAddItem=function(){var e=document.createElement("td");e.setAttribute("style","background-color: LightGray;");var t=document.createElement("a");t.setAttribute("id","add-item"),t.setAttribute("href","#"),t.setAttribute("style","color: black;"),t.appendChild(document.createTextNode("Add item...")),e.appendChild(t);var n=document.createElement("tr");return n.appendChild(e),n},saveSucceeded=async function(){setSaveSuccess(),await sleep(1e3),setSaveDefault()},saveFailed=async function(){setSaveFail(),await sleep(1e3),confirm("Changes could not be saved.\nNew changes may have been made to this Session, so this page will auto-refresh.\nIf the problem persists, please contact the site maintainers using the Help link below.")&&location.reload()},setSaveDefault=function(){var e=document.getElementById("save-button");e.removeAttribute("disabled"),e.innerHTML="Save",e.style.backgroundColor="#69a0f3"},setSaveInProgress=function(){var e=document.getElementById("save-button");e.setAttribute("disabled","disabled"),e.innerHTML="Saving...",e.style.backgroundColor="#69a0f3"},setSaveSuccess=function(){var e=document.getElementById("save-button");e.setAttribute("disabled","disabled"),e.innerHTML="Saved",e.style.backgroundColor="green"},setSaveFail=function(){var e=document.getElementById("save-button");e.setAttribute("disabled","disabled"),e.innerHTML="Failed",e.style.backgroundColor="red"},setSaveLock=function(){var e=document.getElementById("save-button");e.setAttribute("disabled","disabled"),e.innerHTML="Locked",e.style.backgroundColor="LightGray"},setupWishlistListeners=function(e){if(e){var t=document.getElementById("list_"+state.user);for(i=1;i<t.children.length;i++)t.children[i].addEventListener("contextmenu",function(e){e.preventDefault(),_onRemoveItem(e.target)}),t.children[i].addEventListener("dblclick",function(e){_onShowDescr(e.target)});state.isLockedDown||(document.getElementById("add-item").addEventListener("click",function(e){e.preventDefault(),_onAddItem()}),document.getElementById("save-button").addEventListener("click",function(e){_onSave(e.target)}))}var n=document.getElementById("other-lists");for(i=0;i<n.children.length;i++)for(list=n.children[i],j=1;j<list.children.length;j++)list.children[j].addEventListener("dblclick",function(e){_onShowDescr(e.target)});document.getElementById("signout-link").addEventListener("click",function(){_onSignOut()})},_onSignOut=function(){n(),homepage.init()},_onAddItem=function(){if(!state.isLockedDown){var t=document.getElementById("list_"+state.user);if(t.children.length>=10)alert("No more than 8 items are allowed per list.");else{var n={name:"",owner:state.user,claimer:"",price:""};e.push(n);var s=createItem(n);s.addEventListener("contextmenu",function(e){e.preventDefault(),_onRemoveItem(e.target)}),s.addEventListener("dblclick",function(e){_onShowDescr(e.target)}),t.insertBefore(s,t.children[t.children.length-1])}}},_onRemoveItem=function(e){if(!state.isLockedDown){for(var t=document.getElementById("list_"+state.user),n=e.parentElement.parentElement,s=-1,i=0;i<t.rows.length;i++)if(t.rows[i]==n){s=i;break}-1!=s&&1!=s&&confirm("Delete item "+e.innerText+"?")&&t.deleteRow(s)}},_onShowDescr=function(e){var t=document.getElementById("item-descr");if(!(t.children.length>0)){var n=null,s=(n=e.children.length>1?e.parentElement:e.parentElement.parentElement).parentElement.firstChild.firstChild.innerText,i=n.firstChild.children[1].innerText,r=n.firstChild.firstChild.innerText,a=n.firstChild.lastChild.textContent,o=document.createElement("span");o.appendChild(document.createTextNode(i));var l=document.createElement("span"),c=r.length>0?" ("+r+")":"";l.appendChild(document.createTextNode(c));var d=document.createElement("div");a=a.length>0?a:"No description yet.",d.appendChild(document.createTextNode(a)),state.user!=s||state.isLockedDown||d.setAttribute("contenteditable","");var u=document.createElement("button");if(u.appendChild(document.createTextNode("Close")),u.style.backgroundColor="LightGray",u.addEventListener("click",function(){_onHideDescr(n.firstChild.lastChild,!1)}),t.appendChild(o),t.appendChild(l),t.appendChild(document.createElement("hr")),t.appendChild(d),t.appendChild(document.createElement("hr")),t.appendChild(u),state.user==s){var m=document.createElement("button");m.appendChild(document.createTextNode("Save")),m.addEventListener("click",function(){_onHideDescr(n.firstChild.lastChild,!0)}),t.appendChild(document.createTextNode(" ")),t.appendChild(m)}$("#item-descr").show()}},_onHideDescr=function(e,t){var n=document.getElementById("item-descr");if(t){var s=n.getElementsByTagName("div")[0].textContent;e.textContent=s,_onSave()}n.innerHTML="",$("#item-descr").hide()},_onSave=async function(){setSaveInProgress();var e=[],t=[],n=document.getElementById("lists").children[0];for(j=1;j<n.children.length-1;j++){var s=n.children[j].firstChild.children[1].innerText,r=n.children[j].firstChild.firstChild.innerText,a=n.children[j].firstChild.lastChild.textContent;e.push({Name:s,Session:state.session,Owner:state.user,Claimer:"",Price:r,Order:j-1,Descr:a})}var o=document.getElementById("other-lists");for(i=0;i<o.children.length;i++){var l=o.children[i],c=l.firstChild.firstChild.innerText;for(j=1;j<l.children.length;j++){var d=l.children[j].firstChild;if(4==d.children.length){var u=d.children[2].checked?state.user:"";r=d.firstChild.innerText,a=d.lastChild.textContent;t.push({Name:d.children[1].innerText,Session:state.session,Owner:c,Claimer:u,Price:r,Order:j-1,Descr:a})}}}websocketApp.updateItems(e,t)},{init:async function(){state.session=cookieHandler.getSession(),state.user=cookieHandler.getUser(),websocketApp.init();for(var e=20;e>0&&!state.socketConnected;e--)await sleep(1e3);state.socketConnected?(homepage.close(),s(),$("#logged-in").show(),r()):(alert("Web socket failed to connect."),n(),homepage.init())},close:n,redrawOtherLists:async function(){for(var t=await restApp.getItems(),n=[],s=0;s<e.length;s++)e[s].owner==state.user&&n.push(e[s]);for(s=0;s<t.length;s++)t[s].owner!=state.user&&n.push(t[s]);e=n,refreshOwners();clearLists(!1),populateLists(!1),setupWishlistListeners(!1)},saveSucceeded:saveSucceeded,saveFailed:saveFailed}}(),cookieHandler=function(){var e=function(e){for(var t=e+"=",n=document.cookie.split(";"),s=0;s<n.length;s++){for(var i=n[s];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""},t=function(e,t,n){var s=new Date;s.setTime(s.getTime()+24*n*60*60*1e3);var i="expires="+s.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"};return{clearCookies:function(){t("wl_user",null),t("wl_session",null)},getSession:function(){var t=e("wl_session");return null==t?"":t},getUser:function(){var t=e("wl_user");return null==t?"":t},setSession:function(e){t("wl_session",e,5)},setUser:function(e){t("wl_user",e,5)}}}(),restApp={signIn:function(e){if(isBlankString(state.session)||isBlankString(state.user))return!1;var t=new XMLHttpRequest;switch(t.open("PUT","/signin",!1),t.send(JSON.stringify({sessionName:state.session,username:state.user,password:e})),t.status){case 200:return!0;case 401:return!1;default:alert("Something went wrong."),location.reload()}},getItems:function(){var e=new XMLHttpRequest;e.open("GET","/lists/"+state.session.replace(" ","%20"),!1),e.send();var t=JSON.parse(e.responseText),n=[];for(i=0;i<t.length;i++)n.push({name:t[i].Name,owner:t[i].Owner,claimer:t[i].Owner!=state.user?t[i].Claimer:"",price:null!=t[i].Price?t[i].Price:"",descr:t[i].Descr});return n},updateItems:function(e,t){var n=new XMLHttpRequest;switch(n.open("PUT","/lists/"+state.session.replace(" ","%20"),!1),n.send(JSON.stringify({userName:state.user,userItems:e,otherItems:t})),n.status){case 200:return!0;default:return!1}}},websocketApp=function(){var e,t,n=function(){e.onopen=function(e){state.socketConnected=!0},e.onerror=function(t){console.error("Websocket encounter and error: ",t.message),console.error("Closing socket"),e.close()},e.onmessage=function(e){var t=e.data;t.startsWith("save-success")?t.substring(t.indexOf(":")+1)==state.user?wishlistApp.saveSucceeded():wishlistApp.redrawOtherLists():t.startsWith("save-fail")?t.substring(t.indexOf(":")+1)==state.user&&wishlistApp.saveFailed():"server-error"==t&&(alert("Something went wrong."),location.reload())},e.onclose=function(e){state.socketConnected=!1;var t=cookieHandler.getSession(),n=cookieHandler.getUser();isBlankString(t)||isBlankString(n)||(console.log("Socket closed, reconnecting..."),setTimeout(function(){s()},1e3))}},s=function(){href=window.location.href,t=href.replace(window.location.protocol,"ws:"),t+="ws/"+state.session.replace(/\s/g,""),e=new WebSocket(t),n()};return{init:s,close:function(){null!=e&&e.close()},updateItems:function(t,n){h={session:state.session,user:state.user,userItems:t,claimItems:n},e.send("update:"+JSON.stringify(h))}}}();